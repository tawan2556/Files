<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการเอกสาร</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background:white; padding:20px; border-radius:8px; width:90%; max-width:600px; }
        .toast { position: fixed; top: 12px; right: 12px; z-index: 60; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 6px; }
        .card { background: white; border-radius: 8px; padding: 18px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .disabled { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>
<script>
    const appScriptUrl = 'https://script.google.com/macros/s/AKfycbxeWcoVmjOw5sQbcb4sz62Jgs657N1JSbey5gsOpBscCIh7z7ZpkIFgjAALc22eEnKJHg/exec'; // <--- เปลี่ยนตรงนี้
</script>

<div id="login-section" class="min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold mb-6">ระบบจัดการเอกสาร</h2>
    <label class="block mb-2 text-sm">รหัสพนักงาน</label>
    <input id="loginUserId" class="w-full border p-2 rounded mb-4" />
    <label class="block mb-2 text-sm">รหัสผ่าน</label>
    <input id="loginPassword" type="password" class="w-full border p-2 rounded mb-4" />
    <button id="loginBtn" class="w-full bg-blue-600 text-white py-2 rounded">เข้าสู่ระบบ</button>
  </div>
</div>

<div id="app-section" class="hidden min-h-screen p-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">ระบบจัดการเอกสาร</h1>
    <div class="flex items-center space-x-3">
      <div>ผู้ใช้งาน: <span id="userName" class="font-semibold"></span> (<span id="userRole" class="font-semibold text-blue-600"></span>)</div>
      <button id="changePwdBtn" class="bg-yellow-400 px-3 py-1 rounded">เปลี่ยนรหัสผ่าน</button>
      <button id="manageUserBtn" class="bg-purple-600 text-white px-3 py-1 rounded hidden">จัดการผู้ใช้</button>
      <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded">ออกจากระบบ</button>
    </div>
  </div>
  
  <div class="flex justify-end mb-4">
    <button id="addDocBtn" class="bg-blue-600 text-white px-4 py-2 rounded">เพิ่มเอกสาร</button>
  </div>

  <div id="doc-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

  <div class="mt-8 bg-white p-4 rounded-lg flex justify-between items-center">
    <div>จัดทำโปรแกรมโดย <span class="text-blue-600">Tawan Sunday</span></div>
    <div class="text-sm space-x-4">
      <span>จำนวนเอกสาร: <strong id="total-docs">0</strong></span>
      <span>จำนวนผู้ใช้งาน: <strong id="total-users">0</strong></span>
      <span>ระบบโค้ด: <span id="status-code" class="px-2 py-1 rounded bg-green-500 text-white">พร้อมใช้งาน</span></span>
      <span>ระบบฐานข้อมูล: <span id="status-db" class="px-2 py-1 rounded bg-green-500 text-white">พร้อมใช้งาน</span></span>
    </div>
  </div>
</div>

<div id="doc-modal" class="modal">
  <div class="modal-content">
    <h3 id="modal-title" class="text-xl font-bold mb-3">เพิ่มเอกสาร</h3>
    <form id="doc-form">
      <div class="mb-3">
        <label class="block mb-1">ชื่อเอกสาร</label>
        <input id="docName" class="w-full border p-2 rounded" required />
      </div>
      <div class="mb-3">
        <label class="block mb-1">ตำแหน่ง</label>
        <select id="docLocation" class="w-full border p-2 rounded">
          <option value="พนักงาน">พนักงาน</option>
          <option value="ผู้ช่วย">ผู้ช่วย</option>
          <option value="FC">FC</option>
          <option value="ผู้จัดการ">ผู้จัดการ</option>
        </select>
      </div>
      <div class="mb-3" id="file-section">
        <label class="block mb-1">ไฟล์ (ไม่บังคับ)</label>
        <input id="docFile" type="file" class="w-full" />
        <p id="currentFile" class="text-sm text-gray-600 mt-2 hidden"></p>
      </div>
      <div class="flex justify-end space-x-2">
        <button type="button" id="closeDocModal" class="px-4 py-2 border rounded">ยกเลิก</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">บันทึก</button>
      </div>
    </form>
  </div>
</div>

<div id="reauth-modal" class="modal">
  <div class="modal-content">
    <h3 class="text-xl font-bold mb-3">ยืนยันตัวตน (หมดเวลาใช้งาน)</h3>
    <p class="mb-3">กรุณากรอกรหัสผ่านเพื่อยืนยันตัวตน (ผู้ใช้ปัจจุบัน)</p>
    <input id="reauthPassword" type="password" class="w-full border p-2 rounded mb-3" />
    <div class="flex justify-end space-x-2">
      <button id="reauthCancel" class="px-4 py-2 border rounded">ออกจากระบบ</button>
      <button id="reauthSubmit" class="px-4 py-2 bg-blue-600 text-white rounded">ยืนยัน</button>
    </div>
  </div>
</div>

<div id="users-modal" class="modal">
  <div class="modal-content">
    <h3 class="text-xl font-bold mb-3">จัดการผู้ใช้</h3>
    <div class="mb-3">
      <button id="createUserBtn" class="bg-green-600 px-3 py-1 text-white rounded">สร้างผู้ใช้ใหม่</button>
    </div>
    <div class="overflow-auto max-h-80">
      <table class="w-full text-left">
        <thead>
          <tr class="text-sm text-gray-600">
            <th class="p-2">รหัสพนักงาน</th>
            <th class="p-2">ชื่อ</th>
            <th class="p-2">บทบาท</th>
            <th class="p-2">จัดการ</th>
          </tr>
        </thead>
        <tbody id="users-tbody"></tbody>
      </table>
    </div>
    <div class="mt-3 flex justify-end">
      <button id="closeUsersModal" class="px-4 py-2 border rounded">ปิด</button>
    </div>
  </div>
</div>

<div id="user-edit-modal" class="modal">
  <div class="modal-content">
    <h3 id="user-edit-title" class="text-xl font-bold mb-3">สร้างผู้ใช้</h3>
    <form id="user-edit-form">
      <input id="originalUserId" type="hidden" />
      <div class="mb-3">
        <label class="block mb-1">รหัสพนักงาน</label>
        <input id="userIdInput" class="w-full border p-2 rounded" required />
      </div>
      <div class="mb-3">
        <label class="block mb-1">ชื่อ</label>
        <input id="userNameInput" class="w-full border p-2 rounded" required />
      </div>
      <div class="mb-3" id="password-div">
        <label class="block mb-1">รหัสผ่าน</label>
        <input id="userPasswordInput" type="password" class="w-full border p-2 rounded" />
      </div>
      <div class="mb-3">
        <label class="block mb-1">บทบาท</label>
        <select id="userRoleInput" class="w-full border p-2 rounded">
          <option value="พนักงาน">พนักงาน</option>
          <option value="ผู้ช่วย">ผู้ช่วย</option>
          <option value="FC">FC</option>
          <option value="ผู้จัดการ">ผู้จัดการ</option>
          <option value="ADMIN">ADMIN</option>
        </select>
      </div>
      <div class="flex justify-end space-x-2">
        <button type="button" id="cancelUserEdit" class="px-4 py-2 border rounded">ยกเลิก</button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">บันทึก</button>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
    // ---------- state ----------
    let currentUserId = null;
    let currentUserName = null;
    let currentUserRole = null;
    let editingDocId = null;
    let originalSavedBy = null;
    let inactivityTimer = null;
    let lastActivity = Date.now();
    const INACTIVITY_LIMIT = 3 * 60 * 1000; // 3 minutes

    // ---------- helpers ----------
    function showToast(msg, timeout=3000) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.remove('hidden');
        setTimeout(()=> t.classList.add('hidden'), timeout);
    }
    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function hideModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function resetInactivity() {
        lastActivity = Date.now();
        if (document.getElementById('reauth-modal').style.display === 'flex') {
            // if reauth modal open, do nothing (must reauth)
        }
    }
    
    // attach activity listeners
    ['click','mousemove','keydown','scroll','touchstart'].forEach(evt => {
        window.addEventListener(evt, resetInactivity);
    });

    setInterval(()=> {
        if (!currentUserId) return;
        const now = Date.now();
        if (now - lastActivity >= INACTIVITY_LIMIT) {
            // show reauth modal
            showModal('reauth-modal');
            document.getElementById('reauthPassword').value = '';
        }
    }, 5000);

    // ---------- API helpers ----------
    async function postForm(data) {
        try {
            const res = await fetch(appScriptUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams(data)
            });
            return await res.json();
        } catch (err) {
            console.error(err);
            return { success:false, error:'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้' };
        }
    }

    async function postJSON(jsonData) {
        try {
            const res = await fetch(appScriptUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(jsonData)
            });
            return await res.json();
        } catch (err) {
            console.error(err);
            return { success:false, error:'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้' };
        }
    }

    async function fetchGET(q) {
        try {
            const res = await fetch(`${appScriptUrl}?type=${q}`);
            return await res.json();
        } catch (err) {
            console.error(err);
            return { success:false, error:'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้' };
        }
    }

    // ---------- Login ----------
    document.getElementById('loginBtn').addEventListener('click', async () => {
        const userId = document.getElementById('loginUserId').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        if (!userId || !password) { Swal.fire('ผิดพลาด','กรุณากรอกข้อมูลให้ครบ','error'); return; }
        showToast('กำลังเข้าสู่ระบบ...');
        const r = await postForm({ type:'login', userId, password });
        if (r.success) {
            currentUserId = r.data.userId;
            currentUserName = r.data.name;
            currentUserRole = r.data.role;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('userName').innerText = currentUserName;
            document.getElementById('userRole').innerText = currentUserRole;
            // show manage users only for ADMIN
            document.getElementById('manageUserBtn').style.display = (currentUserRole === 'ADMIN') ? 'inline-block' : 'none';
            resetInactivity();
            await loadDocuments();
            await updateStats();
        } else {
            Swal.fire('ผิดพลาด', r.error || 'เข้าสู่ระบบไม่สำเร็จ', 'error');
        }
    });

    // ---------- Load documents and render ----------
    async function loadDocuments() {
        const r = await fetchGET('read');
        if (!r.success) { Swal.fire('ผิดพลาด', r.error || 'ไม่สามารถโหลดเอกสารได้', 'error'); return; }
        renderDocuments(r.data || []);
    }

    function renderDocuments(docs) {
        const list = document.getElementById('doc-list');
        list.innerHTML = '';
        docs.forEach(doc => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="text-sm text-gray-500 mb-2">รหัส: ${doc['รหัส']}</div>
                <div class="text-lg font-bold mb-2">${doc['ชื่อเอกสาร']}</div>
                <div class="text-sm text-gray-600 mb-1">ตำแหน่ง: ${doc['ตำแหน่ง']}</div>
                <div class="text-sm text-gray-600 mb-1">บันทึกโดย: ${doc['บันทึกโดย'] || '-'}</div>
                <div class="text-sm text-gray-600 mb-3">อัปเดตล่าสุด: ${doc['อัปเดตล่าสุด'] || '-'}</div>
                <div class="flex justify-between items-center">
                    <div>${doc['ไฟล์'] ? `<a href="${doc['ไฟล์']}" target="_blank" class="text-blue-600" onclick="event.stopPropagation()">ดาวน์โหลดไฟล์</a>` : '<span class="text-gray-400">ไม่มีไฟล์</span>'}</div>
                    <div class="space-x-3 text-sm">
                        <button data-doc='${JSON.stringify(doc)}' class="editBtn text-yellow-600">แก้ไข</button>
                        ${ (currentUserRole==='ผู้จัดการ' || currentUserRole==='ADMIN' || doc['บันทึกโดย']===currentUserName) ? `<button data-code="${doc['รหัส']}" data-saved="${doc['บันทึกโดย']}" class="deleteBtn text-red-600">ลบ</button>` : '' }
                    </div>
                </div>`;
            list.appendChild(card);
        });
        // wire events
        document.querySelectorAll('.editBtn').forEach(btn => btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const doc = JSON.parse(btn.getAttribute('data-doc'));
            openEditModal(doc);
        }));
        document.querySelectorAll('.deleteBtn').forEach(btn => btn.addEventListener('click', async (e)=>{
            e.stopPropagation();
            const code = btn.getAttribute('data-code');
            const savedBy = btn.getAttribute('data-saved');
            await deleteDocument(code, savedBy);
        }));
    }

    // ---------- Add / Edit doc ----------
    document.getElementById('addDocBtn').addEventListener('click', ()=> {
        editingDocId = null;
        originalSavedBy = null;
        document.getElementById('modal-title').innerText = 'เพิ่มเอกสาร';
        document.getElementById('doc-form').reset();
        document.getElementById('currentFile').style.display = 'none';
        document.getElementById('file-section').style.display = 'block';
        const sel = document.getElementById('docLocation');
        if (currentUserRole !== 'ADMIN') { sel.value = currentUserRole; sel.disabled = true; }
        else { sel.disabled = false; }
        showModal('doc-modal');
    });

    function openEditModal(doc) {
        editingDocId = doc['รหัส'];
        originalSavedBy = doc['บันทึกโดย'];
        document.getElementById('modal-title').innerText = 'แก้ไขเอกสาร';
        document.getElementById('docName').value = doc['ชื่อเอกสาร'] || '';
        const sel = document.getElementById('docLocation');
        sel.value = doc['ตำแหน่ง'] || 'พนักงาน';
        if (currentUserRole !== 'ADMIN') { sel.disabled = true; }
        else { sel.disabled = false; }
        if (doc['ไฟล์']) {
            document.getElementById('currentFile').innerText = `ไฟล์ปัจจุบัน: ${doc['ไฟล์']}`;
            document.getElementById('currentFile').style.display = 'block';
            document.getElementById('file-section').style.display = 'none';
        } else {
            document.getElementById('currentFile').style.display = 'none';
            document.getElementById('file-section').style.display = 'block';
        }
        showModal('doc-modal');
    }

    document.getElementById('closeDocModal').addEventListener('click', ()=> hideModal('doc-modal'));

    async function uploadFileBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                try {
                    const r = await postJSON({ type:'upload', filename: file.name, mimeType: file.type, base64Data: base64 });
                    if (r.success) resolve(r.data);
                    else reject(r.error || 'upload failed');
                } catch (err) { reject(err); }
            };
            reader.onerror = (err) => reject(err);
            reader.readAsDataURL(file);
        });
    }

    document.getElementById('doc-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('docName').value.trim();
        const loc = document.getElementById('docLocation').value;
        const fileInput = document.getElementById('docFile');
        if (!name || !loc) { Swal.fire('ผิดพลาด','กรุณากรอกข้อมูลให้ครบ','warning'); return; }
        showToast('กำลังบันทึก...');

        try {
            let fileUrl = '';
            // If editing and no new file selected, get the original file URL
            if (editingDocId && document.getElementById('file-section').style.display === 'none') {
                 // Get the document data from the button's data attribute
                const docData = JSON.parse(document.querySelector(`button[data-doc*="${editingDocId}"]`).getAttribute('data-doc'));
                fileUrl = docData['ไฟล์'] || '';
            } else if (fileInput.files && fileInput.files.length) {
                const res = await uploadFileBase64(fileInput.files[0]);
                fileUrl = res.fileUrl;
            }

            const params = {
                type: editingDocId ? 'update' : 'insert',
                docId: editingDocId || '',
                docName: name,
                docLocation: loc,
                docFile: fileUrl,
                updatedBy: currentUserName,
                originalSavedBy: originalSavedBy || '',
                role: currentUserRole
            };

            const saveRes = await postForm(params);

            if (saveRes.success) {
                Swal.fire('สำเร็จ','บันทึกเอกสารเรียบร้อย','success');
                hideModal('doc-modal');
                await loadDocuments();
                await updateStats();
            } else {
                Swal.fire('ผิดพลาด', saveRes.error || 'บันทึกล้มเหลว', 'error');
            }
        } catch (err) {
            console.error(err);
            Swal.fire('ผิดพลาด','เกิดข้อผิดพลาด', 'error');
        } finally {
            editingDocId = null; originalSavedBy = null;
        }
    });

    // ---------- Delete ----------
    async function deleteDocument(code, savedBy) {
        const isOwner = (savedBy === currentUserName);
        if (!(currentUserRole === 'ผู้จัดการ' || currentUserRole === 'ADMIN' || isOwner)) {
            Swal.fire('ข้อผิดพลาด','คุณไม่มีสิทธิ์ลบเอกสารนี้','error'); return;
        }
        const c = await Swal.fire({ title:'ลบเอกสาร', text:'ยืนยันการลบ?', icon:'warning', showCancelButton:true });
        if (!c.isConfirmed) return;
        showToast('กำลังลบ...');
        const res = await postForm({ type:'delete', docCode: code, updatedBy: currentUserName, role: currentUserRole });
        if (res.success) {
            Swal.fire('สำเร็จ','ลบเอกสารเรียบร้อย','success');
            await loadDocuments();
            await updateStats();
        } else {
            Swal.fire('ผิดพลาด', res.error || 'ลบไม่สำเร็จ', 'error');
        }
    }

    // ---------- Stats ----------
    async function updateStats() {
        const r = await fetchGET('stats');
        if (!r.success) return;
        document.getElementById('total-docs').innerText = r.data.docCount;
        document.getElementById('total-users').innerText = r.data.userCount;
        document.getElementById('status-code').innerText = r.data.codeStatus === 'green' ? 'พร้อมใช้งาน' : 'กำลังแก้ไข';
        document.getElementById('status-db').innerText = r.data.dbStatus === 'green' ? 'พร้อมใช้งาน' : 'กำลังแก้ไข';
    }

    // ---------- Re-auth (inactivity) ----------
    document.getElementById('reauthSubmit').addEventListener('click', async () => {
        const pwd = document.getElementById('reauthPassword').value.trim();
        if (!pwd) { Swal.fire('ผิดพลาด','กรุณากรอกรหัสผ่าน','warning'); return; }
        const r = await postForm({ type:'login', userId: currentUserId, password: pwd });
        if (r.success) {
            lastActivity = Date.now();
            hideModal('reauth-modal');
            showToast('ยืนยันตัวตนสำเร็จ');
        } else {
            Swal.fire('ผิดพลาด','รหัสผ่านไม่ถูกต้อง','error');
        }
    });
    document.getElementById('reauthCancel').addEventListener('click', () => {
        location.reload();
    });

    // ---------- Change password ----------
    document.getElementById('changePwdBtn').addEventListener('click', () => {
        Swal.fire({
            title: 'เปลี่ยนรหัสผ่าน',
            input: 'password',
            inputLabel: 'รหัสผ่านใหม่',
            showCancelButton: true
        }).then(async (res) => {
            if (res.isConfirmed) {
                const newPwd = res.value;
                const r = await postForm({ type:'changePassword', name: currentUserName, newPassword: newPwd });
                if (r.success) Swal.fire('สำเร็จ','เปลี่ยนรหัสผ่านเรียบร้อย','success'); else Swal.fire('ผิดพลาด', r.error || 'ล้มเหลว', 'error');
            }
        });
    });

    // ---------- Manage users ----------
    document.getElementById('manageUserBtn').addEventListener('click', async () => {
        await loadUsers();
        showModal('users-modal');
    });
    document.getElementById('closeUsersModal').addEventListener('click', ()=> hideModal('users-modal'));
    document.getElementById('createUserBtn').addEventListener('click', ()=> {
        document.getElementById('user-edit-title').innerText = 'สร้างผู้ใช้ใหม่';
        document.getElementById('user-edit-form').reset();
        document.getElementById('password-div').style.display = 'block';
        document.getElementById('originalUserId').value = '';
        showModal('user-edit-modal');
    });
    document.getElementById('cancelUserEdit').addEventListener('click', ()=> hideModal('user-edit-modal'));

    async function loadUsers() {
        const r = await fetchGET('readUsers');
        if (!r.success) { Swal.fire('ผิดพลาด', r.error || 'ไม่สามารถโหลดผู้ใช้', 'error'); return; }
        const tbody = document.getElementById('users-tbody');
        tbody.innerHTML = '';
        (r.data || []).forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-2">${u.userId || ''}</td><td class="p-2">${u.name || ''}</td><td class="p-2">${u.role || ''}</td>
                <td class="p-2">
                    <button class="editUserBtn px-2 py-1 bg-yellow-400 rounded">แก้ไข</button>
                    ${ (currentUserRole === 'ADMIN') ? `<button data-user-id="${u.userId}" class="adminPwdBtn px-2 py-1 bg-red-400 text-white rounded ml-1">เปลี่ยนรหัสผ่าน</button>` : '' }
                </td>`;
            tbody.appendChild(tr);
            tr.querySelector('.editUserBtn').addEventListener('click', ()=> openEditUserModal(u));
            if(currentUserRole === 'ADMIN') {
                tr.querySelector('.adminPwdBtn').addEventListener('click', async (e) => {
                    const targetUserId = e.target.getAttribute('data-user-id');
                    const { value: newPwd } = await Swal.fire({
                        title: `เปลี่ยนรหัสผ่านผู้ใช้ ${targetUserId}`,
                        input: 'password',
                        inputLabel: 'รหัสผ่านใหม่',
                        showCancelButton: true,
                        confirmButtonText: 'บันทึก'
                    });
                    if (newPwd) {
                        const r = await postForm({ type: 'adminChangePassword', userId: targetUserId, newPassword: newPwd });
                        if (r.success) {
                            Swal.fire('สำเร็จ', `เปลี่ยนรหัสผ่านสำหรับ ${targetUserId} เรียบร้อย`, 'success');
                        } else {
                            Swal.fire('ผิดพลาด', r.error || 'ล้มเหลว', 'error');
                        }
                    }
                });
            }
        });
    }

    function openEditUserModal(user) {
        document.getElementById('user-edit-title').innerText = 'แก้ไขผู้ใช้';
        document.getElementById('originalUserId').value = user.userId;
        document.getElementById('userIdInput').value = user.userId;
        document.getElementById('userNameInput').value = user.name;
        document.getElementById('userRoleInput').value = user.role;
        document.getElementById('password-div').style.display = 'none';
        showModal('user-edit-modal');
    }

    document.getElementById('user-edit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const original = document.getElementById('originalUserId').value;
        const userId = document.getElementById('userIdInput').value.trim();
        const name = document.getElementById('userNameInput').value.trim();
        const pwd = document.getElementById('userPasswordInput').value;
        const role = document.getElementById('userRoleInput').value;
        if (!userId || !name || (!original && !pwd)) { Swal.fire('ผิดพลาด','ข้อมูลไม่ครบ','warning'); return; }
        if (original) {
            const r = await postForm({ type:'updateUser', originalUserId: original, newUserId: userId, name, role });
            if (r.success) { Swal.fire('สำเร็จ','แก้ไขผู้ใช้เรียบร้อย','success'); hideModal('user-edit-modal'); await loadUsers(); }
            else Swal.fire('ผิดพลาด', r.error || 'ล้มเหลว', 'error');
        } else {
            const r = await postForm({ type:'createUser', userId, name, password: pwd, role });
            if (r.success) { Swal.fire('สำเร็จ','สร้างผู้ใช้เรียบร้อย','success'); hideModal('user-edit-modal'); await loadUsers(); }
            else Swal.fire('ผิดพลาด', r.error || 'ล้มเหลว', 'error');
        }
    });

    // ---------- Logout ----------
    document.getElementById('logoutBtn').addEventListener('click', ()=> location.reload());

    // ---------- Init ----------
    (async ()=> {
        // nothing to do until login
    })();
</script>
</body>
</html>